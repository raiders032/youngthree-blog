## 1 Lambda

- AWS Lambda는 개발자가 서버의 프로비저닝이나 관리 없이 코드를 실행할 수 있게 해주는 서버리스 컴퓨팅 서비스입니다.
- 이벤트 중심의 설계로 다양한 애플리케이션과 백엔드 서비스에 최적화되어 있으며, 사용자는 사용한 만큼의 비용만 지불하면 됩니다.
- AWS의 200개 이상 서비스와 다양한 SaaS 애플리케이션에서 Lambda를 트리거할 수 있습니다.



### 1.1 작동 방식

- AWS Lambda를 사용하면 서버의 설정, 스케일링 또는 관리에 신경 쓸 필요 없이 코드를 실행할 수 있습니다.
- 사용자는 단순히 코드를 Lambda로 업로드하면 됩니다.
    - 업로드는 ZIP 파일 형태나 컨테이너 이미지로 가능합니다.
- 이후, 이벤트를 기반으로 하여 코드가 자동으로 실행됩니다.
    - 예를 들어, S3 버킷에 새 파일이 업로드 될 때마다 코드가 실행될 수 있습니다.
- Lambda는 이벤트의 유형과 크기에 따라 자동으로 컴퓨팅 리소스를 조정하고, 실행된 코드에 대해서만 요금을 부과합니다.



### 1.2 Lambda 언어 지원

- Node.js (JavaScript)
- Python
- Java (Java 8 호환)
- C# (.NET Core)
- Golang
- C# / Powershell
- Ruby
- Custom Runtime API (커뮤니티 지원, 예: Rust)
- Lambda 컨테이너 이미지
    - 컨테이너 이미지는 Lambda Runtime API를 구현해야 합니다.
    - 임의의 Docker 이미지를 실행하는 경우 ECS / Fargate 사용 권장



## 2 Lambda의 이점

### 2.1 서버 관리 불필요

- 인프라를 프로비저닝하거나 관리하지 않고 코드를 실행합니다.
- zip 파일 또는 컨테이너 이미지로 코드를 작성하고 업로드하면 됩니다.
- AWS가 서버의 프로비저닝, 유지보수, 확장 등을 자동으로 처리합니다.
- 개발자는 코드의 실행에만 집중할 수 있습니다.



### 2.2 자동 조정

- 하루에 수십 개의 이벤트에서 초당 수십만 개에 이르기까지 어떤 규모에서든 코드 실행 요청에 자동으로 응답합니다.
- Lambda는 요청의 수에 따라 자동으로 확장되므로, 사용자는 코드가 항상 적절한 규모로 실행되는 것을 확신할 수 있습니다.



### 2.3 종량 요금제 및 Compute Savings Plan

- 피크 용량에 대해 사전에 인프라를 프로비저닝하는 대신, 밀리초 기준으로 사용하는 컴퓨팅 시간에 대해서만 요금을 지불하여 비용을 절감합니다.
- AWS Lambda는 실행된 컴퓨팅 시간을 밀리초 단위로 측정하여 요금을 부과합니다.
    - 이는 사용하지 않는 리소스에 대한 비용이 발생하지 않음을 의미합니다.
    - 따라서, 피크 시간에만 리소스를 사용하는 애플리케이션에 이상적입니다.
- **Compute Savings Plan**
    - 1년 또는 3년 기간 동안 일정한 금액을 지불하여 모든 AWS 컴퓨팅 서비스에서 할인 혜택을 받을 수 있습니다.
    - Lambda, EC2, Fargate 등 다양한 서비스에 적용됩니다.
    - 예측 가능한 사용량에 대해 비용을 더욱 절감할 수 있습니다.



### 2.4 성능 최적화

- 올바른 함수 메모리 크기로 코드 실행 시간 및 성능을 최적화합니다.
- 프로비저닝된 동시성으로 두 자릿수 밀리초 단위에서 높은 수요에 응답합니다.



### 2.5 쉬운 가격 책정

- 요청 수와 컴퓨팅 시간에 따라 요금을 지불합니다.
- 1,000,000개의 AWS Lambda 요청과 400,000GB의 컴퓨팅 시간이 무료로 제공됩니다.
- AWS의 전체 서비스 스위트와 통합되어 있으며, 여러 프로그래밍 언어를 지원합니다.
- AWS CloudWatch를 통해 쉽게 모니터링할 수 있습니다.
- 함수당 더 많은 리소스를 쉽게 추가할 수 있으며, 최대 10GB의 RAM을 지원합니다.
    - RAM을 늘리면 CPU와 네트워크 성능도 향상됩니다.



## 3 Lambda 가격 예시

- 전체 가격 정보는 [AWS Lambda 가격 페이지](https://aws.amazon.com/lambda/pricing/)에서 확인할 수 있습니다.
- 요청당 요금:
    - 처음 1,000,000개의 요청은 무료
    - 그 이후 1,000,000 요청당 $0.20 ($0.0000002 per request)
- 지속 시간당 요금 (1ms 단위로 증가):
    - 매월 400,000 GB-초의 컴퓨팅 시간 무료 제공
        - 함수가 1GB RAM일 경우 400,000초에 해당
        - 함수가 128MB RAM일 경우 3,200,000초에 해당
    - 그 이후 600,000 GB-초당 $1.00
- AWS Lambda 실행 비용은 보통 매우 저렴하여 인기가 많습니다.



## 4 Lambda 제한 사항 (지역별)

### 4.1 실행

- 메모리 할당: 128 MB – 10GB (1 MB 단위)
- 최대 실행 시간: 900초 (15분)
- 환경 변수: 4 KB  
- "함수 컨테이너"의 디스크 용량 (/tmp에): 512 MB ~ 10GB
- 동시 실행 수: 1000 (증가 가능)



### 4.2 배포

- Lambda 함수 배포 크기 (압축된 .zip): 50 MB
- 압축 해제된 배포 크기 (코드 + 종속성): 250 MB
    - 시작 시 다른 파일을 로드하기 위해 /tmp 디렉토리를 사용할 수 있음
- 환경 변수 크기: 4 KB



## 5 Lambda 메모리, CPU 및 네트워크 설정

### 5.1 메모리 설정

- AWS Lambda에서는 메모리를 128MB부터 10,240MB(10GB)까지 1MB 단위로 설정할 수 있습니다.



### 5.2 CPU 성능

- Lambda 함수의 CPU 성능은 메모리 할당량에 비례하여 자동으로 할당됩니다.
- 메모리를 더 많이 할당할수록, 함수에 할당되는 CPU 성능도 향상됩니다.
- 예를 들어, 256MB 메모리를 할당한 함수보다 512MB 메모리를 할당한 함수의 CPU 성능이 두 배가 됩니다.
- **성능 최적화**:
    - 더 높은 메모리를 할당하여 함수의 실행 시간을 줄이고, 결과적으로 비용을 절감할 수 있습니다.
    - 성능 요구사항에 따라 메모리와 CPU의 균형을 조정합니다.



### 5.3 네트워크 성능

- Lambda 함수의 네트워크 성능 또한 할당된 메모리와 연관이 있습니다.
- **네트워크 대역폭**: 메모리 할당량이 증가함에 따라 네트워크 대역폭도 비례하여 증가합니다.
- **구체적인 연관성**:
    - 1,769MB 이하: 최대 네트워크 대역폭이 제한됩니다.
    - 1,769MB 초과: 네트워크 대역폭이 점진적으로 증가합니다.
    - 10,240MB(최대): 최대 10Gbps의 네트워크 대역폭을 제공합니다.
- **성능 영향**:
    - 대용량 데이터 전송이 필요한 함수의 경우, 더 높은 메모리 할당을 통해 네트워크 성능을 개선할 수 있습니다.
    - 예를 들어, 대용량 파일을 S3에 업로드하거나 다운로드하는 작업의 경우 높은 메모리 설정이 유리할 수 있습니다.



### 5.4 최적화 방법

- **메모리, CPU 및 네트워크 설정 조정**
    - 애플리케이션의 성능 요구사항에 따라 메모리, CPU, 네트워크 할당을 종합적으로 고려하여 조정합니다.
    - 예를 들어, CPU 집약적이면서 동시에 대용량 데이터 전송이 필요한 함수는 더 많은 메모리를 할당하여 CPU와 네트워크 성능을 모두 최적화할 수 있습니다.
- **비용 효율성 고려**:
	- 메모리를 많이 할당하면 CPU와 네트워크 성능이 향상되어 실행 시간이 줄어들 수 있지만, 비용도 증가할 수 있습니다. 
	- 따라서 성능과 비용 간의 균형을 맞추는 것이 중요합니다.
- **워크로드 분석**
	- 함수의 워크로드 특성(CPU 집약적, 메모리 집약적, 네트워크 집약적)을 분석하여 최적의 설정을 찾습니다.



## 6 Lambda 네트워크 설정

### 6.1 기본 설정

- 기본적으로, Lambda 함수는 AWS 소유의 VPC에서 실행됩니다.
	- 이 경우 Lambda 함수는 기본적으로 인터넷에 연결할 수 있습니다. 
	- AWS가 관리하는 네트워크 인프라를 통해 인터넷 액세스가 제공되기 때문입니다.
- 따라서, 사용자의 VPC에 있는 리소스(RDS, ElastiCache, 내부 ELB 등)에 접근할 수 없습니다.



### 6.2 VPC 내 Lambda 설정

- Lambda 함수를 VPC 내에서 실행하려면 다음 요소들을 정의해야 합니다:
    1. VPC ID: 함수가 실행될 VPC를 지정합니다.
    2. 서브넷: 최소 두 개 이상의 서브넷을 선택하여 고가용성을 확보합니다.
    3. 보안 그룹: 함수의 네트워크 트래픽을 제어합니다.
- 설정 과정:
    1. Lambda 콘솔에서 함수 생성 또는 수정 시 "네트워크" 섹션에서 VPC 설정을 구성합니다.
    2. AWS CLI나 SDK를 사용할 경우, 함수 생성/수정 시 VPC 설정을 포함시킵니다.
- ENI(Elastic Network Interface) 생성:
    - Lambda 서비스가 지정된 서브넷 내에 자동으로 ENI를 생성합니다.
    - 이 ENI는 Lambda 함수와 VPC 리소스 간의 통신을 가능하게 합니다.
    - ENI 생성 과정은 몇 분 정도 소요될 수 있습니다.
- 주의사항:
    1. VPC 내 Lambda는 기본적으로 인터넷에 접근할 수 없습니다. 인터넷 접근이 필요한 경우 NAT Gateway나 VPC 엔드포인트를 구성해야 합니다.
    2. VPC 내 Lambda 함수는 cold start 시간이 더 길어질 수 있습니다.
    3. 사용하지 않는 ENI는 자동으로 정리되지만, 간혹 수동 정리가 필요할 수 있습니다.
- 필요한 IAM 권한:
    - Lambda 실행 역할에 "AWSLambdaVPCAccessExecutionRole" 정책을 추가해야 합니다.
    - 이 정책은 Lambda가 VPC 리소스에 접근하고 ENI를 관리할 수 있게 해줍니다.
- 네트워크 액세스 제어:
    - 보안 그룹을 통해 Lambda 함수의 인바운드 및 아웃바운드 트래픽을 제어합니다.
    - 예: RDS 접근 시, Lambda 보안 그룹에서 RDS 포트로의 아웃바운드 트래픽을 허용하고, RDS 보안 그룹에서 Lambda 보안 그룹으로부터의 인바운드 트래픽을 허용해야 합니다.
- 모니터링 및 로깅:
    - VPC 내 Lambda 함수의 네트워크 성능과 연결 문제를 모니터링하기 위해 CloudWatch 로그와 메트릭을 활용합니다.



### 6.3 VPC 내 Lambda의 인터넷 접근

- VPC 내에서 실행되는 Lambda 함수는 기본적으로 인터넷에 접근할 수 없습니다.
- 퍼블릭 서브넷에 Lambda 함수를 배포하는 것만으로는 인터넷 접근이 제공되지 않습니다.
    - 퍼블릭 IP 주소도 자동으로 할당되지 않습니다.
- Lambda 함수를 퍼블릭 서브넷에 배포하는 것은 일반적인 EC2 인스턴스를 퍼블릭 서브넷에 배포하는 것과는 다른 결과를 가져옵니다. 
	- Lambda는 항상 프라이빗 IP만을 사용하며, 인터넷 접근을 위해서는 별도의 NAT 구성이 필요합니다.
- CloudWatch Logs 접근
    - Lambda 함수는 VPC 설정과 관계없이 CloudWatch Logs에 로그를 전송할 수 있습니다.
    - 별도의 엔드포인트나 NAT Gateway 설정 없이도 작동합니다.



**인터넷 접근을 위한 구성 옵션**

1. NAT Gateway / NAT Instance 사용:
    - 프라이빗 서브넷에 Lambda 함수를 배포하고 NAT Gateway를 통해 인터넷 접근을 제공합니다.
    - NAT Gateway는 퍼블릭 서브넷에 위치해야 하며, 인터넷 게이트웨이(IGW)와 연결되어야 합니다.
2. VPC 엔드포인트 사용:
    - AWS 서비스에 대한 프라이빗 접근을 제공합니다.
    - NAT Gateway 없이도 DynamoDB, S3 등의 AWS 서비스에 안전하게 접근할 수 있습니다.
    - 인터넷을 통과하지 않고 AWS 네트워크 내에서 직접 연결됩니다.



**구현 시 고려사항**

- 인터넷 접근이 필요한 경우: NAT Gateway 사용
- AWS 서비스만 접근 필요한 경우: VPC 엔드포인트 사용
- 완전한 네트워크 격리가 필요한 경우: 엔드포인트만 사용하고 NAT Gateway는 구성하지 않음



## 7 Lambda와 RDS Proxy

### 7.1 RDS Proxy 사용 이유

- Lambda 함수가 데이터베이스에 직접 접근하면, 고부하 시 너무 많은 연결을 열 수 있습니다.
- RDS Proxy를 사용하면 다음과 같은 이점이 있습니다:
    - 데이터베이스 연결을 풀링하고 공유하여 확장성을 향상시킵니다.
    - 장애 조치 시간을 66% 줄이고 연결을 유지하여 가용성을 향상시킵니다.
    - IAM 인증을 강제하고 자격 증명을 Secrets Manager에 저장하여 보안을 향상시킵니다.
- RDS Proxy가 공개적으로 접근할 수 없기 때문에 Lambda 함수를 VPC 내에 배포되어야 합니다.



## 8 RDS 및 Aurora에서 Lambda 호출

### 8.1 데이터베이스 인스턴스에서 Lambda 함수 호출

- 데이터베이스 인스턴스 내에서 Lambda 함수를 호출할 수 있습니다.
- 이를 통해 데이터베이스 내에서 데이터 이벤트를 처리할 수 있습니다.
- RDS for PostgreSQL 및 Aurora MySQL에서 지원됩니다.
- 데이터베이스 인스턴스에서 Lambda 함수로의 아웃바운드 트래픽을 허용해야 합니다 (Public, NAT GW, VPC Endpoints).
- 데이터베이스 인스턴스는 Lambda 함수를 호출할 수 있는 권한을 가져야 합니다 (Lambda 리소스 기반 정책 및 IAM 정책).



## 9 Lambda와 SQS DLQ 설정

- Lambda 함수가 처리하지 못한 메시지를 SQS DLQ로 전송하여 재처리 및 분석할 수 있도록 설정합니다.



### 9.1 DLQ 설정 이유

- 네트워크 문제나 코드 오류 등으로 인해 Lambda 함수가 실패하는 경우, 처리되지 않은 메시지를 안전하게 보관합니다.
- DLQ를 사용하면 실패한 메시지를 나중에 다시 처리하거나 분석할 수 있습니다.
- 모든 메시지가 손실 없이 처리되도록 보장합니다.



### 9.2 SQS 큐 생성

- AWS Management Console에 로그인합니다.
- Amazon SQS 콘솔로 이동합니다.
- "Create queue" 버튼을 클릭합니다.
- 큐 이름을 입력하고 필요한 설정을 완료한 후 "Create Queue"를 클릭합니다.



### 9.3 Lambda 함수에 DLQ 설정

- Lambda 콘솔에서 함수를 선택합니다.
- "Configuration" > "Destinations" > "Asynchronous invocation"으로 이동합니다.
- "On failure" 설정에서 "Amazon SQS queue"를 선택합니다.
- 이전에 생성한 SQS 큐를 선택합니다.
- "Save" 버튼을 클릭하여 설정을 저장합니다.



### 9.4 SNS 주제에 DLQ 설정

- SNS 주제에 대한 구독을 생성하거나 편집합니다.
- 구독 설정에서 "Delivery policy"를 통해 재시도 정책과 DLQ를 설정합니다.
- SQS 큐 URL을 DLQ 설정에 입력합니다.



### 9.5 Lambda 함수에서 SQS 메시지 재처리

- Lambda 함수가 DLQ의 메시지를 읽고 다시 처리할 수 있도록 코드를 수정합니다.

#### Lambda 함수 예시 코드

```python
import boto3
import json

sqs = boto3.client('sqs')

def lambda_handler(event, context):
    for record in event['Records']:
        # SQS 메시지 처리 로직을 여기에 작성
        message = record['body']
        try:
            # 메시지 처리
            process_message(message)
        except Exception as e:
            print(f"Error processing message: {e}")
            # 실패한 메시지는 다시 SQS에 넣거나 다른 처리 방법을 사용할 수 있음
            sqs.send_message(
                QueueUrl='https://sqs.<region>.amazonaws.com/<account-id>/<queue-name>',
                MessageBody=message
            )

def process_message(message):
    # 실제 메시지 처리 로직을 여기에 작성
    data = json.loads(message)
    # 데이터 처리 코드

```



### 9.6 DLQ 모니터링 및 관리

- Amazon CloudWatch를 사용하여 DLQ에서 처리되지 않은 메시지를 모니터링할 수 있습니다.
- CloudWatch 알람을 설정하여 DLQ의 메시지 수가 일정 수치를 초과할 경우 알림을 받을 수 있습니다.
- DLQ에서 메시지를 주기적으로 확인하고 필요한 경우 수동으로 재처리할 수 있습니다.



**참고 자료**

- [AWS Lambda 가격](https://aws.amazon.com/lambda/pricing/)
- [Lambda 기능 개요](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)
- [CloudFront Functions 및 Lambda@Edge](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/edge-functions.html)