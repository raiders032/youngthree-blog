## 1 CloudTrail

- AWS CloudTrail은 AWS 계정의 운영 및 위험 감사, 거버넌스, 규정 준수를 활성화하는 데 도움이 되는 서비스입니다.
- 사용자, 역할 또는 AWS 서비스에 의해 수행된 작업은 CloudTrail 이벤트로 기록됩니다.
- 이러한 이벤트에는 AWS Management Console, AWS Command Line Interface, AWS SDK 및 API에서 수행된 작업이 포함됩니다.
- CloudTrail은 AWS account를 생성할 때 자동으로 활성화됩니다.
- AWS 계정에서 활동이 발생하면 해당 활동은 CloudTrail 이벤트에 기록됩니다.



## 2 CloudTrail Event 종류

### 2.1 Management Events (관리 이벤트)

- 관리 이벤트는 AWS 계정 내에서 자원(Resource)들에 대해 수행된 작업(Operations)을 기록합니다.
- **예시**:
    - **보안 구성**: IAM 정책을 역할에 첨부하는 작업 (예: `IAM AttachRolePolicy`)
    - **라우팅 규칙 설정**: EC2 서브넷을 생성하는 작업 (예: `Amazon EC2 CreateSubnet`)
    - **로깅 설정**: CloudTrail에서 새로운 트레일을 생성하는 작업 (예: `AWS CloudTrail CreateTrail`)
- **특징**:
    - 기본적으로 CloudTrail은 관리 이벤트를 기록하도록 설정되어 있습니다.
    - 읽기 이벤트(Read Events)와 쓰기 이벤트(Write Events)를 구분할 수 있습니다. 
    - 읽기 이벤트는 자원을 변경하지 않는 작업, 쓰기 이벤트는 자원을 변경할 수 있는 작업을 의미합니다.



### 2.2 Data Events (데이터 이벤트)

- 데이터 이벤트는 AWS 리소스에 대한 세부적인 작업(주로 고빈도 작업)을 기록합니다.
- **예시**:
    - **Amazon S3 객체 수준 활동**: 예를 들어, 객체 가져오기(GetObject), 삭제(DeleteObject), 추가(PutObject) 등의 작업.
    - **AWS Lambda 함수 실행 활동**: `Invoke API`를 통한 Lambda 함수 호출.
- **특징**:
    - 기본적으로 데이터 이벤트는 기록되지 않습니다. 
    - 이는 데이터 이벤트가 높은 빈도로 발생하기 때문에 기본 설정에서는 로그를 남기지 않도록 되어 있습니다.
    - 데이터 이벤트에서도 읽기 이벤트와 쓰기 이벤트를 구분할 수 있습니다.



### 2.3 CloudTrail Insights Events

- CloudTrail 인사이트 이벤트는 계정에서 발생하는 비정상적인 활동을 자동으로 탐지하고 기록하는 기능입니다.
- **기능**
	- 이 기능은 특정 활동이나 API 호출에서 발생하는 갑작스러운 변화 또는 이상치를 탐지하여 추가적인 분석 및 경고를 제공합니다. 
	- 예를 들어, 평소보다 훨씬 많은 API 호출이 발생한 경우, 이는 보안 침해 또는 시스템 오류를 나타낼 수 있습니다.



## 3 이벤트 기록 방식

- CloudTrail은 이벤트를 기록하기 위해 세 가지 방법을 제공합니다:



### 3.1 이벤트 히스토리

- 이벤트 히스토리는 AWS 리전에서 지난 90일간의 관리 이벤트를 조회, 검색, 다운로드할 수 있는 기능을 제공합니다.
- 단일 속성으로 필터링하여 이벤트를 쉽게 검색할 수 있습니다.
- AWS 계정을 생성하면 자동으로 이벤트 히스토리에 접근할 수 있으며, 이를 조회하는 데는 비용이 발생하지 않습니다.



### 3.2 CloudTrail Lake

- AWS CloudTrail Lake는 감사 및 보안 목적으로 AWS의 사용자 및 API 활동을 캡처, 저장, 액세스, 분석할 수 있는 관리형 데이터 레이크입니다.
- 기존 이벤트를 행 기반 JSON 형식에서 검색 최적화된 열 기반 저장 형식인 Apache ORC 형식으로 변환합니다.
- 이벤트 데이터는 고급 이벤트 선택기를 사용하여 필터링되고, 선택된 이벤트는 데이터 저장소에 집계됩니다.
- 데이터는 최대 10년(3,653일) 또는 7년(2,557일) 동안 저장할 수 있으며, 선택한 보존 기간에 따라 비용이 부과됩니다.
- Lake에서 쿼리를 실행할 때 스캔된 데이터 양에 따라 추가 비용이 발생합니다.



### 3.3 트레일

- 트레일은 AWS 계정의 활동 기록을 Amazon S3 버킷으로 전달하여 저장합니다.
- CloudWatch Logs 및 Amazon EventBridge로 이벤트를 전달할 수 있는 옵션도 제공합니다.
- 이 기능을 사용하면 보안 모니터링 솔루션에 이벤트를 입력하고, Amazon Athena와 같은 도구를 사용하여 CloudTrail 로그를 검색하고 분석할 수 있습니다.
- 단일 AWS 계정이나 AWS Organizations를 사용하여 여러 AWS 계정에 대한 트레일을 생성할 수 있습니다.
- 트레일을 생성하여 관리 이벤트를 S3 버킷으로 전달하는 데는 비용이 발생하지 않지만, S3 저장소 비용은 부과됩니다.
- 또한, Insights 이벤트를 기록하여 API 호출 볼륨과 오류율의 이상 동작을 분석할 수 있습니다.



## 4 CloudTrail의 주요 기능

- CloudTrail은 보안 및 운영 모범 사례의 주요 측면인 AWS 계정 활동에 대한 가시성을 제공합니다.
- CloudTrail을 사용하여 AWS 인프라 전반에 걸친 계정 활동을 조회, 검색, 다운로드, 아카이브, 분석 및 대응할 수 있습니다.
- 누가 어떤 작업을 수행했는지, 어떤 리소스가 작동되었는지, 이벤트가 언제 발생했는지 등을 식별하여 계정 활동을 분석하고 대응할 수 있습니다.
- CloudTrail은 API를 사용하여 애플리케이션에 통합하고, 조직을 위한 트레일 또는 이벤트 데이터 저장소 생성을 자동화하며, 생성한 이벤트 데이터 저장소 및 트레일의 상태를 확인하고, 사용자가 CloudTrail 이벤트를 보는 방식을 제어할 수 있습니다.



## 5 CloudTrail 이벤트 보존

- 이벤트는 CloudTrail에서 90일 동안 저장됩니다.
- 이 기간 이후에도 이벤트를 유지하려면 S3에 기록하고 Athena를 사용해야 합니다.



## 6 CloudTrail 사용 사례: Amazon EventBridge를 통한 API 호출 인터셉트

![[Pasted image 20240704101216.png]]

- CloudTrail은 AWS 계정 내에서 발생하는 모든 API 호출을 기록하여 보안 및 운영 모니터링을 돕습니다.
- 아래는 CloudTrail과 Amazon EventBridge를 사용하여 중요한 API 호출을 인터셉트하고 경고를 생성하는 사용 사례를 설명합니다.



### 6.1 사용 사례 개요

- 사용자가 DynamoDB 테이블을 삭제하는 API 호출을 수행합니다.
- 이 API 호출은 CloudTrail에 의해 기록됩니다.
- CloudTrail은 기록된 이벤트를 Amazon EventBridge로 전달합니다.
- EventBridge는 특정 이벤트(예: DeleteTable API 호출)를 감지하고 트리거를 발생시킵니다.
- 이 트리거는 SNS를 통해 알림을 전송합니다.



### 6.2 세부 프로세스

- **사용자**: DynamoDB 테이블 삭제와 같은 중요한 작업을 수행합니다.
- **DynamoDB**: 사용자의 API 호출을 처리하고, 해당 호출이 CloudTrail에 의해 기록됩니다.
- **CloudTrail**: 모든 API 호출을 로그로 남기며, 이 로그는 이후 분석과 모니터링에 사용됩니다.
- **Amazon EventBridge**: CloudTrail로부터 이벤트를 수신하고, 특정 조건(예: DeleteTable 호출)에 맞는 이벤트를 감지합니다.
- **SNS**: EventBridge에서 발생한 이벤트에 따라 경고를 생성하여 관리자가 신속하게 대응할 수 있도록 합니다.



### 6.3 실시간 모니터링 및 대응

- CloudTrail과 EventBridge를 함께 사용함으로써, 실시간으로 중요한 API 호출을 모니터링하고 즉각적인 대응이 가능합니다.
- 예를 들어, 중요한 리소스가 삭제되는 경우, 즉시 알림을 받아 빠르게 문제를 파악하고 조치할 수 있습니다.




## 7 CloudWatch vs CloudTrail vs Config

- **CloudWatch**
    - 성능 모니터링 (메트릭, CPU, 네트워크 등) 및 대시보드
    - 이벤트 및 경고
    - 로그 집계 및 분석
- **CloudTrail**
    - 계정 내에서 수행된 API 호출 기록
    - 특정 리소스에 대한 트레일 정의 가능
    - 글로벌 서비스
- **Config**
    - 구성 변경 기록
    - 리소스를 규정 준수 규칙과 비교 평가
    - 구성 변경 및 준수 상태의 타임라인 제공



### 7.1 Elastic Load Balancer 예시

- CloudWatch
	- **모니터링 인커밍 연결 메트릭**
	    - ELB로 들어오는 모든 연결을 실시간으로 모니터링할 수 있습니다.
	- **오류 코드 시각화**
	    - 시간 경과에 따른 오류 코드를 %로 시각화하여 문제를 식별할 수 있습니다.
	- **대시보드 구성**
	    - ELB 성능에 대한 대시보드를 만들어 전체적인 성능을 한눈에 파악할 수 있습니다.
- Config
	- **보안 그룹 규칙 추적**
	    - ELB에 적용된 보안 그룹 규칙을 추적할 수 있습니다.
	- **구성 변경 추적**
	    - ELB의 구성 변경 사항을 지속적으로 모니터링할 수 있습니다.
	- **SSL 인증서 준수 확인**
	    - ELB에 항상 SSL 인증서가 할당되었는지 확인하여 보안 규정을 준수할 수 있습니다.
- CloudTrail
	- **API 호출 추적**
	    - ELB에 대한 모든 API 호출을 추적하여 누가 어떤 변경을 했는지 기록할 수 있습니다.
