## 1 SecretsManager

- [레퍼런스](https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html)
- 클라우드 컴퓨팅 영역에서는 데이터베이스 자격 증명, 애플리케이션 키, OAuth 토큰, API 키와 같은 민감한 정보를 보호하는 것이 중요합니다.
- AWS Secrets Manager는 수명 주기 전반에 걸쳐 이러한 민감 정보의 관리, 검색 및 교체를 간소화하도록 설계된 강력한 도구입니다.



### 1.1 AWS Secrets Manager의 주요 기능

- **시크릿 수명주기 관리**
	- Secrets Manager는 생성부터 폐기까지 시크릿을 관리하는 도구를 제공하여 시크릿을 항상 최신 상태로 안전하게 유지합니다.
- **자동 시크릿 교체**
	- Secrets Manager의 뛰어난 기능 중 하나는 정의된 일정에 따라 시크릿 교체를 자동화하는 기능입니다.
	- 이렇게 하면 장기 자격 증명을 단기 자격 증명으로 교체하여 관련 위험을 줄일 수 있습니다.
- **런타임 시 보안 검색**
	- Secrets Manager를 사용하면 애플리케이션 소스 코드에 하드 코딩된 자격 증명이 필요하지 않습니다.
	- 대신 애플리케이션이 런타임 시 Secrets Manager를 호출하여 자격 증명을 동적으로 검색할 수 있습니다.
	- 이러한 관행은 잠재적인 위반에 대한 노출을 최소화하여 보안을 크게 강화합니다.
- **AWS 서비스와의 통합**
	- 많은 AWS 서비스는 Secrets Manager와 원활하게 통합되어 AWS 환경 전체에서 암호를 저장하고 액세스하는 프로세스를 단순화하도록 설계되었습니다.



## 2 프로세스

1. 요청하기: 애플리케이션은 AWS SDK를 활용하여 Secrets Manager로 요청을 보내고, 특정 이름이나 ARN에 연결된 시크릿 값을 요구합니다. 
2. 인증 및 권한 부여: AWS는 요청을 보낸 IAM 역할이나 사용자에게 부여된 IAM 정책을 검토하여 해당 시크릿에 접근할 권한이 있는지 확인합니다. 
3. 시크릿 검색: 인증과 권한 부여가 성공적으로 이루어지면, Secrets Manager는 저장된 시크릿을 암호화된 상태로 가져와 AWS KMS를 이용하여 해독한 뒤, 애플리케이션에 평문 값으로 반환합니다.
4. 시크릿 사용: 이후 애플리케이션은 데이터베이스 비밀번호 등의 시크릿 값을 사용하여 애플리케이션 소스 코드에 자격 증명을 직접 코딩하지 않고도 데이터베이스나 서비스와의 연결을 구성합니다.



## 3  AWS Systems Manager Parameter Store와 비교

### 3.1 AWS Systems Manager Parameter Store

**가격** 
- Parameter Store는 기본적인 사용에 대해 무료이며, 고급 파라미터에 대해서만 비용이 발생합니다.

**기능**
- Parameter Store는 간단한 데이터 문자열, 암호화된 문자열 또는 암호화되지 않은 긴 문자열 등 다양한 유형의 데이터를 저장할 수 있습니다. 
- 이를 통해 환경 변수, 구성 데이터, 비밀번호 등을 저장할 수 있습니다.

**보안**
- AWS KMS(Key Management Service)를 사용하여 파라미터를 암호화할 수 있으며, IAM(Identity and Access Management)을 통해 액세스 제어를 관리합니다.

**자동 회전**
- 자체적으로 자동 회전 기능을 제공하지 않지만, Lambda 함수와 결합하여 회전 로직을 구현할 수 있습니다.

**통합**
- AWS CloudFormation, Elastic Container Service(ECS), Lambda 등 다른 AWS 서비스와의 통합을 지원합니다.



### 3.2 AWS Secrets Manager

**가격**
- Secrets Manager는 사용한 만큼 비용을 지불하는 서비스입니다. 
- 비밀 관리 및 회전 기능에 대해 비용이 발생합니다.

**기능**
- Secrets Manager는 데이터베이스 자격 증명, API 키 및 토큰 같은 민감한 정보를 안전하게 저장하고 관리하는 데 특화되어 있습니다.

**보안**
- 자동 회전, 암호화, 액세스 제어 및 감사 로그와 같은 고급 보안 기능을 제공합니다. 
- AWS KMS를 사용하여 비밀을 암호화하며, IAM 정책을 통해 세밀한 액세스 제어가 가능합니다.

**자동 회전**
- 데이터베이스 자격 증명과 같은 시크릿을 자동으로 교체할 수 있는 내장 지원이 있으며, 이는 데이터베이스와 직접 통합될 수 있습니다.

**통합**
- AWS RDS, Redshift, DocumentDB 등과 같은 AWS 서비스와의 긴밀한 통합을 제공합니다. 또한, 애플리케이션에 비밀을 주입하는 방식을 단순화합니다.



## 4 자동 회전 (Automatic Rotation)

- [레퍼런스](https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html)
- AWS Secrets Manager는 두 가지 방법으로 시크릿의 자동 회전을 지원합니다.
- 첫 번째 방법은 관리형 회전(Managed Rotation)으로, Secrets Manager가 회전 프로세스를 자동으로 관리합니다.
    - 관리형 회전은 Lambda 함수를 사용하지 않으며, 서비스가 회전 작업을 설정하고 관리합니다.
    - 예를 들어, Amazon RDS와 통합되어 데이터베이스 자격 증명을 자동으로 회전할 수 있습니다.
    - 지원 목록
        - Amazon RDS
        - Amazon ECS
        - Amazon Aurora
        - Amazon Redshift
- 두 번째 방법은 **Lambda 함수를 사용하는 회전**으로, 시크릿과 데이터베이스 또는 서비스를 업데이트하기 위해 Lambda 함수를 사용합니다.
    - 이 방법은 관리형 회전을 지원하지 않는 다른 유형의 시크릿에 사용됩니다.
    - 사용자 정의 로직을 포함하는 Lambda 함수를 설정하여, 시크릿 회전 시 데이터베이스의 자격 증명을 업데이트하고 Secrets Manager에 새 값을 저장할 수 있습니다.
    - 비 RDS 데이터베이스나 사용자 정의 시크릿 유형의 회전을 위해서는 트리거 시 시크릿을 회전하는 AWS Lambda 함수를 생성하고 구성해야 합니다. 
    - 회전 함수는 보호된 서비스의 자격 증명을 업데이트하고 시크릿을 일치하도록 업데이트합니다. 
    - 그러면 애플리케이션은 즉시 시크릿에 포함된 새 자격 증명을 사용하여 보호된 서비스에 접근하기 시작합니다. 
    - Rotation Function Templates은 AWS Secrets Manager에서 제공하는 사전 구성된 Lambda 함수 템플릿입니다.
        - 이 템플릿들은 다양한 유형의 시크릿에 대한 자동 로테이션을 구현하는 데 사용됩니다.



**회전 과정**

- **시크릿 생성**: 자동 회전이 활성화되면, Secrets Manager는 주기적으로 새로운 자격 증명을 생성합니다.
- **자격 증명 업데이트**: 생성된 새로운 자격 증명을 데이터베이스 또는 서비스에 업데이트합니다.
- **시크릿 저장**: 업데이트된 자격 증명을 Secrets Manager에 저장하여, 애플리케이션이 새로운 자격 증명을 사용할 수 있도록 합니다.
- **Lambda 함수 활용**: 필요에 따라 Lambda 함수를 사용하여 시크릿 회전 로직을 사용자 정의할 수 있습니다.



**시크릿 회전 예시**

- 예를 들어, 데이터베이스 자격 증명의 자동 회전을 설정하면, Secrets Manager는 주기적으로 새로운 자격 증명을 생성하고 데이터베이스 설정을 업데이트하여, 애플리케이션이 중단 없이 새로운 자격 증명을 사용할 수 있도록 보장합니다.
- 이러한 자동화된 회전 프로세스는 보안성을 강화하고, 자격 증명의 유효 기간을 줄여 보안 위험을 최소화합니다.



### 4.1 일정 설정

![[Pasted image 20240827161759.png]]

- 회전 주기를 설정할 수 있습니다.
- 두 가지 옵션이 제공됩니다:
	- 일정 표현식 빌더
	- 일정 표현식 직접 입력
- 일정 표현식 빌더를 사용하면 다음과 같은 설정이 가능합니다
	- 시간 단위 선택 (예: 시간)
	- 회전 주기 설정 (예: 23시간마다)
	- 윈도우 지속 시간 설정 (선택 사항, 예: 4시간)
		- 윈도우 지속 시간은 회전이 실행될 수 있는 시간 범위를 지정합니다. 
		- 예를 들어, 4시간으로 설정하면 지정된 회전 시간으로부터 4시간 이내에 회전이 무작위로 실행됩니다. 
		- 이는 시스템 부하를 분산시키고 여러 비밀 정보의 회전이 동시에 발생하는 것을 방지하는 데 도움이 됩니다.
- '비밀 정보가 저장될 때 즉시 회전' 옵션을 선택하면 초기 저장 시 즉시 회전이 수행됩니다.



## 5 AWS Config를 활용한 미사용 시크릿 관리

- AWS Secrets Manager와 AWS Config를 통합하면 사용하지 않는 시크릿을 효과적으로 식별하고 관리할 수 있습니다. 
- 이는 보안을 강화하고 불필요한 비용을 절감하는 데 도움이 됩니다.



### 5.1 AWS Config 규칙 설정

- AWS Config에서 'secretsmanager-secret-unused' 관리형 규칙을 사용합니다.
- 이 규칙은 지정된 기간 동안 사용되지 않은 AWS Secrets Manager의 시크릿을 확인합니다.



### 5.2 규칙 구성

- 규칙 생성 시 'unusedForDays' 파라미터를 설정합니다.
- 기본값은 90일이지만, 조직의 정책에 따라 조정할 수 있습니다.
- 예: 30일 동안 사용되지 않은 시크릿을 식별하려면 'unusedForDays'를 30으로 설정합니다.



### 5.3 규칙 작동 방식

- 설정된 기간 동안 GetSecretValue API 호출이 없는 시크릿은 'NON_COMPLIANT' 상태로 표시됩니다.
- 이를 통해 사용되지 않는 시크릿을 쉽게 식별할 수 있습니다.



### 5.4 자동화된 알림 및 조치

- Amazon EventBridge(CloudWatch Events)를 사용하여 규칙 위반 시 자동 알림을 설정할 수 있습니다.
- Lambda 함수를 트리거하여 미사용 시크릿에 대한 자동 조치(예: 태그 추가, 비활성화 또는 삭제)를 수행할 수 있습니다.



### 5.5 정기적인 검토 및 정리

- 정기적으로 NON_COMPLIANT 상태의 시크릿을 검토합니다.
- 필요 없는 시크릿은 안전하게 삭제하고, 여전히 필요한 시크릿은 재활성화하거나 유지합니다.



## 6 Cross-Region Replication

- AWS Secrets Manager는 네이티브 크로스 리전 복제(Cross-Region Replication)를 지원합니다.
- 이 기능은 기업의 액티브-패시브 페일오버 구성 및 재해 복구 전략과 완벽하게 부합합니다.



### 6.1 크로스 리전 복제의 이점

- **고가용성**: 주 리전에 문제가 발생해도 다른 리전에서 시크릿에 접근할 수 있어 서비스 중단을 최소화합니다.
- **재해 복구**: 자연 재해나 대규모 장애 상황에서도 중요한 시크릿 정보를 보호하고 신속하게 복구할 수 있습니다.
- **지연 시간 감소**: 글로벌 애플리케이션의 경우, 사용자와 가까운 리전에서 시크릿을 조회하여 지연 시간을 줄일 수 있습니다.



### 6.2 구성 방법

- AWS Management Console, AWS CLI, 또는 AWS SDK를 통해 크로스 리전 복제를 설정할 수 있습니다.
- 복제 대상 리전을 선택하고, 필요한 경우 KMS 키를 지정하여 복제된 시크릿을 암호화합니다.



### 6.3 동기화 프로세스

- 시크릿이 생성되거나 업데이트되면 Secrets Manager가 자동으로 복제 리전과 동기화합니다.
- 이 과정은 백그라운드에서 이루어지며, 애플리케이션 운영에 영향을 주지 않습니다.



### 6.4 보안 고려사항

- 복제된 시크릿은 대상 리전에서도 원본과 동일한 수준의 암호화 및 접근 제어를 적용받습니다.
- IAM 정책을 통해 복제된 시크릿에 대한 접근을 세밀하게 제어할 수 있습니다.



### 6.5 모니터링 및 감사

- AWS CloudTrail을 통해 시크릿의 복제 활동을 모니터링하고 감사할 수 있습니다.
- 이를 통해 복제 프로세스의 투명성을 확보하고 규정 준수 요구사항을 충족할 수 있습니다.