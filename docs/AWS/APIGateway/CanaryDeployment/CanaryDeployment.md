## 1 API Gateway의 Canary Deployment 심층 분석

- API Gateway의 Canary Deployment는 새로운 API 버전을 안전하게 테스트하고 배포하는 강력한 기능입니다.
- 이 기능을 통해 개발자는 위험을 최소화하면서 새로운 기능을 빠르게 출시할 수 있습니다.



## 2 Canary Deployment의 작동 원리

- Canary Deployment는 트래픽을 두 가지 버전의 API로 분할합니다:
	- 기존 프로덕션 버전 (v1)
	- 새로운 Canary 버전 (v2)
- 트래픽 분배는 사용자가 지정한 비율에 따라 이루어집니다.
- 예를 들어, 95%의 트래픽은 v1으로, 5%의 트래픽은 v2로 라우팅될 수 있습니다.



## 3 Canary Deployment의 주요 특징

### 3.1 유연한 스테이지 설정

- Canary Deployment는 일반적으로 프로덕션 환경에서 사용됩니다.
- 하지만 개발, 테스트 등 어떤 스테이지에서도 활성화할 수 있습니다.
- 이를 통해 다양한 환경에서 새로운 기능을 테스트할 수 있습니다.



### 3.2 정밀한 트래픽 제어

- Canary 채널로 전송되는 트래픽의 비율을 정확하게 제어할 수 있습니다.
- 0.1%에서 50%까지 세밀하게 조정이 가능합니다.
- 이를 통해 점진적으로 새 버전의 노출을 증가시킬 수 있습니다.



### 3.3 독립적인 모니터링

- Canary 버전에 대한 메트릭과 로그가 기존 버전과 분리되어 있습니다.
- 이를 통해 새 버전의 성능을 정확하게 모니터링하고 분석할 수 있습니다.
- CloudWatch를 통해 상세한 메트릭을 확인할 수 있습니다.



### 3.4 변수 오버라이드

- Canary 버전에 대해 스테이지 변수를 재정의할 수 있는 기능을 제공합니다.
- 이를 통해 새 버전에 대해 다른 백엔드 서비스나 설정을 사용할 수 있습니다.
- 예를 들어, 새로운 데이터베이스 연결 문자열을 테스트할 수 있습니다.



## 4 Canary Deployment 구현 단계

### 4.1 API 생성 및 구성

- API Gateway에서 새로운 API를 생성하거나 기존 API를 선택합니다.
- API의 리소스와 메서드를 구성합니다.



### 4.2 스테이지 생성

- API의 새로운 스테이지를 생성합니다.
- 이 스테이지에서 Canary Deployment를 활성화합니다.



### 4.3 Canary 설정

- Canary 트래픽 비율을 설정합니다.
- Canary에 대한 스테이지 변수 오버라이드를 구성합니다.



### 4.4 배포 및 모니터링

- API를 배포하고 Canary 트래픽을 모니터링합니다.
- CloudWatch를 통해 성능 메트릭을 확인합니다.



### 4.5 프로모션 또는 롤백

- Canary 버전이 안정적이라고 판단되면 전체 트래픽으로 프로모션합니다.
- 문제가 발생하면 즉시 롤백하여 모든 트래픽을 기존 버전으로 되돌립니다.



## 5 프로모션 프로세스

- Canary Deployment의 핵심 단계 중 하나는 프로모션 프로세스입니다.
- 프로모션은 Canary 버전을 전체 트래픽으로 전환하는 과정을 말합니다.



### 5.1 프로모션 시점 결정

- 다음 조건을 고려하여 프로모션 시점을 결정합니다:
  - 에러율: Canary 버전의 에러율이 허용 가능한 수준인지 확인
  - 성능 메트릭: 응답 시간, 처리량 등이 기대치를 충족하는지 검토
  - 사용자 피드백: Canary 사용자로부터 긍정적인 피드백을 받았는지 확인



### 5.2 프로모션 실행

- API Gateway 콘솔에서 'Promote Canary' 옵션을 선택합니다.
- AWS CLI를 사용하는 경우, 다음 명령어를 실행합니다:

    ```bash
    aws apigateway update-stage \
        --rest-api-id <api-id> \
        --stage-name <stage-name> \
        --patch-operations op='replace',path='/canary/percentTraffic',value='100'
    ```



### 5.3 프로모션 후 모니터링

- 프로모션 후에도 지속적으로 API 성능을 모니터링합니다.
- 예상치 못한 문제가 발생할 경우 신속하게 대응할 준비를 합니다.



## 6 Canary Deployment의 모범 사례

- **점진적 트래픽 증가**: 처음에는 작은 비율(예: 5%)로 시작하여 점진적으로 증가시킵니다.
- **자동화된 테스트**: Canary 버전에 대한 자동화된 테스트를 구현하여 지속적으로 품질을 확인합니다.
- **롤백 계획**: 문제 발생 시 신속하게 롤백할 수 있는 계획을 미리 수립합니다.
- **메트릭 기반 의사결정**: 객관적인 메트릭을 기반으로 프로모션 여부를 결정합니다.
- **사용자 피드백 수집**: Canary 사용자로부터의 피드백을 적극적으로 수집하고 분석합니다.



## 7 결론

- API Gateway의 Canary Deployment는 새로운 API 버전을 안전하게 테스트하고 배포하는 강력한 도구입니다.
- 트래픽을 정밀하게 제어하고, 독립적인 모니터링을 통해 위험을 최소화할 수 있습니다.
- 프로모션 프로세스를 통해 성공적인 Canary 버전을 전체 트래픽으로 원활하게 전환할 수 있습니다.
- 이를 통해 개발자는 더 자주, 더 안전하게 새로운 기능을 출시할 수 있으며, 사용자에게 더 나은 경험을 제공할 수 있습니다.