
## 1 VPC

- AWS VPC는 사용자만의 독립된 네트워크 공간을 AWS 클라우드 내에 생성할 수 있게 합니다. 
- 이 공간은 인터넷과 분리되어 있으며, 사용자는 이 공간 안에서 네트워크 설정, 서브넷, 라우팅 테이블, 게이트웨이 등을 자유롭게 구성할 수 있습니다. 
- VPC는 온프레미스 데이터 센터와 유사한 환경을 제공하여, 안전하고 확장 가능한 애플리케이션을 구축할 수 있습니다.
- AWS에서는 한 리전당 최대 5개의 VPC를 가질 수 있습니다.



### 1.1 VPC 구성 요소

- **CIDRs**: VPC에 할당된 IP 주소 범위.
- **Main Route Table**: 서브넷의 기본 네트워크 경로 정의.
- **Main Network ACL**: 서브넷 수준에서 트래픽 제어.
- **Subnets**: VPC 내 더 작은 네트워크 구간.
- **Internet Gateway**: VPC와 인터넷 간 통신 허용.
	- [[InternetGateway]]
- **NAT Gateway**: 프라이빗 서브넷의 인터넷 요청 처리.
- **Security Groups**: 인스턴스 수준 트래픽 제어.
- **VPC Peering**: VPC 간 트래픽 라우팅 연결.
- **Virtual Private Gateway**: 온프레미스 네트워크와 VPC 연결.
- **Transit Gateway**: 여러 VPC와 온프레미스 네트워크 간 중앙 라우팅 허브.



## 2 Default VPC

- 모든 새로운 AWS 계정은 기본 VPC를 갖고 있습니다.
- 서브넷을 지정하지 않으면 새로운 EC2 인스턴스는 기본 VPC에 생성됩니다.
- 기본 VPC는 인터넷 연결을 갖추고 있으며, 내부의 모든 EC2 인스턴스는 공용 IPv4 주소를 가집니다.
- 기본 VPC에서는 공용 및 사설 IPv4 DNS 이름을 제공합니다.



## 3 VPC CIDR

- **CIDR (Classless Inter-Domain Routing)**: VPC에 할당된 IP 주소 범위를 나타냅니다.
- 각 VPC는 최대 5개의 CIDR 블록을 가질 수 있습니다.
- 각 CIDR 블록의 최소 크기는 /28입니다(16개의 IP 주소).
- 각 CIDR 블록의 최대 크기는 /16입니다(65,536개의 IP 주소).
- VPC는 프라이빗 네트워크이므로 사설 IPv4 범위만 허용됩니다:
    - 10.0.0.0 – 10.255.255.255 (10.0.0.0/8)
    - 172.16.0.0 – 172.31.255.255 (172.16.0.0/12)
    - 192.168.0.0 – 192.168.255.255 (192.168.0.0/16)
- VPC의 CIDR 블록은 다른 네트워크(예: 기업 네트워크)와 겹치지 않도록 설정해야 합니다.




## 4 서브넷 (Subnet)

- 서브넷은 VPC 내에서 더 작은 네트워크 구간으로, IP 주소 범위를 정의합니다.
- 서브넷은 반드시 하나의 가용 영역(Availability Zone) 내에 있어야 합니다. 
- 서브넷을 추가한 후에는 VPC 내에 AWS 리소스를 배포할 수 있습니다.
- 서브넷을 인터넷, 다른 VPC, 또는 자신의 데이터 센터와 연결할 수 있으며, 라우팅 테이블을 사용하여 서브넷 간의 트래픽을 라우팅할 수 있습니다.
- 서브넷은 퍼블릭 서브넷과 프라이빗 서브넷으로 나눌 수 있습니다.
- VPC(가상 사설 클라우드)는 하나의 리전 내 모든 가용 영역(Availability Zone)을 아우릅니다. 
	- VPC를 생성한 후 각 가용 영역에 하나 이상의 서브넷을 추가할 수 있습니다.



### 4.1 CIDR 블록과 서브넷의 관계

- **CIDR 블록**: VPC에 할당된 전체 IP 주소 범위입니다.
    - 예: 10.0.0.0/16 CIDR 블록은 65,536개의 IP 주소를 포함합니다.
- **서브넷**: CIDR 블록 내에서 더 작은 IP 주소 범위로 나눈 네트워크 구간입니다.
    - 예: 10.0.1.0/24 서브넷은 256개의 IP 주소를 포함합니다.
- 하나의 CIDR 블록에서 여러 개의 서브넷을 생성할 수 있습니다.
- 예시:
    - **VPC CIDR 블록**: 10.0.0.0/16
        - **서브넷 1**: 10.0.1.0/24
        - **서브넷 2**: 10.0.2.0/24
        - **서브넷 3**: 10.0.3.0/24
- 서브넷을 통해 VPC 내의 네트워크를 세분화하고, 트래픽 라우팅 및 보안을 강화할 수 있습니다.



### 4.2 서브넷의 예약 IP 주소

- AWS는 각 서브넷에서 5개의 IP 주소를 예약합니다(처음 4개와 마지막 1개).
- 이 5개의 IP 주소는 사용할 수 없으며, EC2 인스턴스에 할당될 수 없습니다.
- 예시: 서브넷의 CIDR 블록이 10.0.0.0/24인 경우 예약된 IP 주소는 다음과 같습니다:
    - 10.0.0.0: 네트워크 주소
    - 10.0.0.1: VPC 라우터용으로 AWS에 의해 예약됨
    - 10.0.0.2: Amazon 제공 DNS에 매핑하기 위해 AWS에 의해 예약됨
    - 10.0.0.3: AWS의 미래 사용을 위해 예약됨
    - 10.0.0.255: 네트워크 브로드캐스트 주소, VPC에서 브로드캐스트를 지원하지 않으므로 예약됨



### 4.3 퍼블릭 서브넷과 프라이빗 서브넷

#### 4.3.1 퍼블릭 서브넷

- 퍼블릭 서브넷은 인터넷 게이트웨이를 통해 인터넷과 통신할 수 있는 서브넷입니다.
- 퍼블릭 서브넷의 인스턴스는 공용 IP 주소 또는 Elastic IP 주소를 할당받아 인터넷과 직접 통신할 수 있습니다.
- 공용 IP 주소를 통해 인터넷에서 해당 인스턴스에 접근할 수 있습니다.
- 보안 그룹과 네트워크 ACL을 통해 트래픽 제어 및 보안을 강화할 수 있습니다.
- 웹 서버나 인터넷과 직접 통신해야 하는 리소스를 배포하는 데 적합합니다.



**퍼블릭 서브넷 생성**

- 서브넷 생성: VPC 대시보드에서 서브넷을 생성합니다. 
- 퍼블릭 서브넷의 CIDR 블록을 지정합니다.
- 라우팅 테이블 수정: 퍼블릭 서브넷의 라우팅 테이블에 인터넷 게이트웨이를 추가합니다.
- 라우팅 테이블의 경로 설정에 다음을 추가합니다:
	- 목적지 (Destination): 0.0.0.0/0
	- 대상 (Target): 인터넷 게이트웨이 ID (igw-xxxxxxxx)
- 서브넷에 공용 IP 자동 할당 설정: 퍼블릭 서브넷에 생성되는 EC2 인스턴스가 공용 IP를 자동으로 받도록 설정합니다.



#### 4.3.2 프라이빗 서브넷

- 프라이빗 서브넷은 인터넷과의 직접적인 통신이 차단된 서브넷입니다.
- 프라이빗 서브넷의 인스턴스는 공용 IP 주소를 할당받지 않으며, 인터넷 게이트웨이 없이 외부와의 통신이 불가능합니다.
- 외부 통신이 필요한 경우 NAT 게이트웨이 또는 NAT 인스턴스를 통해 프라이빗 서브넷의 인스턴스가 인터넷으로 나가는 요청을 할 수 있습니다.
- 프라이빗 서브넷의 인스턴스는 내부 네트워크 내에서만 접근할 수 있으며, 데이터베이스 서버, 내부 애플리케이션 서버 등을 배포하는 데 적합합니다.
- 보안 그룹과 네트워크 ACL을 통해 트래픽 제어 및 보안을 강화할 수 있습니다.



**프라이빗 서브넷 생성**

- 서브넷 생성: VPC 대시보드에서 서브넷을 생성합니다. 
- 프라이빗 서브넷의 CIDR 블록을 지정합니다.
- 라우팅 테이블 설정: 프라이빗 서브넷의 라우팅 테이블을 생성하거나 수정합니다.
    - NAT 게이트웨이를 사용하는 경우, 라우팅 테이블에 다음을 추가합니다:
        - 목적지 (Destination): 0.0.0.0/0
        - 대상 (Target): NAT 게이트웨이 ID (nat-xxxxxxxx)
    - NAT 인스턴스를 사용하는 경우, 라우팅 테이블에 다음을 추가합니다:
        - 목적지 (Destination): 0.0.0.0/0
        - 대상 (Target): NAT 인스턴스 ID (i-xxxxxxxx)



#### 4.3.3 서브넷 구분

- **퍼블릭 서브넷**
    - 인터넷 게이트웨이를 통해 인터넷에 접근할 수 있는 서브넷
    - 라우팅 테이블에 인터넷 게이트웨이 경로가 설정되어 있음
    - 서브넷에 자동으로 공용 IP 주소를 할당하도록 설정됨
- **프라이빗 서브넷**
    - NAT 게이트웨이 또는 NAT 인스턴스를 통해서만 인터넷 접근이 가능한 서브넷
    - 라우팅 테이블에 NAT 게이트웨이 또는 NAT 인스턴스 경로가 설정되어 있음
    - 공용 IP 주소를 할당받지 않음



## 6 라우팅 테이블 (Route Table)

- 라우팅 테이블은 서브넷 내의 네트워크 트래픽이 어디로 가야 하는지 결정하는 규칙을 정의합니다.
- 각 서브넷은 하나의 라우팅 테이블에 연결되며, 이 테이블을 통해 네트워크 트래픽이 어떤 경로로 이동할지를 결정합니다.
- 라우팅 테이블은 여러 서브넷에 동시에 적용될 수 있습니다.
- 기본적으로 모든 VPC는 기본 라우팅 테이블(Main Route Table)을 갖고 있으며, 이 테이블은 VPC 내 모든 서브넷에 기본적으로 적용됩니다.
- 라우팅 테이블은 다음과 같은 항목으로 구성됩니다:
    - **목적지 (Destination)**: 트래픽이 향할 IP 주소 범위 (예: 0.0.0.0/0은 모든 트래픽을 의미).
    - **대상 (Target)**: 트래픽을 전달할 다음 홉 (예: 인터넷 게이트웨이, NAT 게이트웨이, VPN 연결 등).
- 라우팅 테이블을 사용자 정의하여 특정 서브넷에 대해 다른 경로를 설정할 수 있습니다.
- 특정 서브넷에 사용자 정의 라우팅 테이블을 연결하면, 해당 서브넷의 트래픽은 사용자 정의 라우팅 테이블의 규칙에 따라 이동합니다.



### 6.1 라우팅 테이블 설정 예시

1. **기본 라우팅 테이블**:
    - **목적지**: 10.0.0.0/16
    - **대상**: local
    - 기본 라우팅 테이블은 VPC를 생성할 때 자동으로 생성됩니다.
    - `10.0.0.0/16`은 VPC의 전체 CIDR 블록으로, VPC 내의 모든 트래픽이 로컬로 라우팅됨을 의미합니다.
    - `local` 대상은 VPC 내에서의 내부 통신을 의미하며, 이 경로는 삭제할 수 없습니다.
2. **퍼블릭 서브넷 라우팅 테이블**:
    - **목적지**: 0.0.0.0/0
    - **대상**: 인터넷 게이트웨이 (igw-xxxxxxxx)
    - 퍼블릭 서브넷의 라우팅 테이블에는 인터넷으로 나가는 경로가 설정되어야 합니다.
    - `0.0.0.0/0`은 모든 트래픽을 의미하며, 이 트래픽이 인터넷으로 나가야 한다는 것을 나타냅니다.
    - `인터넷 게이트웨이 (igw-xxxxxxxx)`는 이 트래픽이 인터넷 게이트웨이를 통해 나가도록 설정합니다.
3. **프라이빗 서브넷 라우팅 테이블**:
    - **목적지**: 0.0.0.0/0
    - **대상**: NAT 게이트웨이 (nat-xxxxxxxx)
    - 프라이빗 서브넷의 라우팅 테이블에는 인터넷으로 나가는 트래픽이 NAT 게이트웨이를 통해 나가도록 설정해야 합니다.
    - `0.0.0.0/0`은 모든 트래픽을 의미하며, 이 트래픽이 NAT 게이트웨이를 통해 나가야 한다는 것을 나타냅니다.
    - `NAT 게이트웨이 (nat-xxxxxxxx)`는 이 트래픽이 NAT 게이트웨이를 통해 나가도록 설정합니다.
    - 이를 통해 프라이빗 서브넷의 인스턴스가 인터넷에 접근할 수 있지만, 외부에서 직접 접근할 수는 없습니다.



## 7 NAT 게이트웨이 (NAT Gateway)

- NAT 게이트웨이는 프라이빗 서브넷에 있는 리소스가 인터넷에 나가서 요청을 할 수 있게 해줍니다. 
- 이는 프라이빗 서브넷의 보안을 유지하면서 외부 인터넷 접근을 가능하게 합니다.
- NAT 게이트웨이를 사용하면 프라이빗 서브넷에 있는 인스턴스가 VPC 외부의 서비스에 연결할 수 있지만, 외부 서비스는 이러한 인스턴스와의 연결을 시작할 수 없습니다.
- AWS에서 관리하는 NAT로, 더 높은 대역폭과 고가용성을 제공하며 관리가 필요하지 않습니다.
- 사용 시간과 대역폭에 따라 요금이 부과됩니다.
- NAT Gateway는 특정 가용 영역에서 생성되며, Elastic IP를 사용합니다.
- 인터넷 게이트웨이(IGW)가 필요합니다 (프라이빗 서브넷 => NAT Gateway => IGW).
- 5 Gbps의 대역폭을 제공하며, 자동으로 최대 100 Gbps까지 확장됩니다.
- 관리할 보안 그룹이 필요하지 않습니다.



### 7.1 NAT 게이트웨이 연결 유형

#### 7.1.1 Public (공용)

- **퍼블릭 NAT 게이트웨이**는 사설 서브넷의 인스턴스가 인터넷에 연결할 수 있도록 합니다.
- 퍼블릭 NAT 게이트웨이는 공용 서브넷에 생성됩니다.
- 퍼블릭 NAT 게이트웨이를 생성할 때 Elastic IP 주소를 할당해야 합니다.
- 사설 서브넷의 인스턴스가 인터넷으로 나가는 트래픽은 퍼블릭 NAT 게이트웨이를 통해 나갑니다.
- 인터넷 게이트웨이가 퍼블릭 NAT 게이트웨이의 사설 IP 주소를 Elastic IP 주소로 변환합니다.
- 인터넷에서 들어오는 비요청 트래픽은 차단되므로 보안이 유지됩니다.



#### 7.1.2 Private (사설)

- **사설 NAT 게이트웨이**는 사설 서브넷의 인스턴스가 다른 VPC나 온프레미스 네트워크와 통신할 수 있도록 합니다.
- 사설 NAT 게이트웨이는 사설 서브넷에 생성됩니다.
- 사설 NAT 게이트웨이에는 Elastic IP 주소를 할당할 수 없습니다.
- 사설 NAT 게이트웨이를 통해 인터넷 게이트웨이로 트래픽을 라우팅할 수 없습니다. 인터넷 게이트웨이가 해당 트래픽을 드롭하기 때문입니다.
- 대신, 사설 NAT 게이트웨이를 통해 Transit Gateway나 Virtual Private Gateway를 통해 다른 VPC나 온프레미스 네트워크로 트래픽을 라우팅할 수 있습니다.



### 7.2 고가용성을 갖춘 NAT 게이트웨이

- NAT 게이트웨이는 단일 가용 영역 내에서 탄력성을 갖습니다.
- 장애 허용성을 위해 여러 가용 영역에 여러 NAT 게이트웨이를 생성해야 합니다.
- 가용 영역이 다운되더라도 교차 가용 영역 장애 조치가 필요하지 않습니다. 
	- 가용 영역이 다운되면 해당 가용 영역 내 모든 리소스가 중단되므로 NAT 게이트웨이도 필요 없게 됩니다.
	- 즉, 가용 영역 내의 인스턴스들이 다운되기 때문에 NAT 게이트웨이를 통해 인터넷에 접근할 인스턴스가 없기 때문입니다.



### 7.3 IPv6 지원

- **NAT 게이트웨이**: AWS NAT 게이트웨이는 IPv6을 직접 지원하지 않습니다. IPv6 트래픽을 다루기 위해서는 다른 대안을 사용해야 합니다.
- **IPv6 전용 트래픽 지원**: IPv6을 사용하는 경우, NAT 게이트웨이 대신 **Egress-Only Internet Gateway**를 사용해야 합니다. Egress-Only Internet Gateway는 VPC의 프라이빗 서브넷에서 인터넷으로 나가는 IPv6 트래픽을 처리하지만, 들어오는 트래픽을 차단합니다.
- **NAT 게이트웨이와의 차이점**: NAT 게이트웨이는 IPv4 트래픽을 변환하여 인터넷과 통신할 수 있도록 하며, Egress-Only Internet Gateway는 IPv6 트래픽을 위한 특화된 솔루션입니다.



## 8 NAT 인스턴스 (NAT Instance)

- NAT 인스턴스는 프라이빗 서브넷의 EC2 인스턴스가 인터넷에 연결할 수 있도록 하는 역할을 합니다.
- NAT 인스턴스는 퍼블릭 서브넷에 생성되어야 하며, Elastic IP가 할당되어야 합니다.
- **Source/Destination Check**를 비활성화해야 합니다.
- 프라이빗 서브넷의 라우팅 테이블을 NAT 인스턴스로 트래픽이 라우팅되도록 구성해야 합니다.
- **종료된 표준 지원**: 2020년 12월 31일에 표준 지원이 종료되었습니다.
- **높은 가용성 부족**: 기본 설정으로는 고가용성을 제공하지 않습니다.
    - 다중 가용 영역에 걸쳐 Auto Scaling Group(ASG)과 탄력적인 사용자 데이터 스크립트를 구성해야 합니다.
- **인터넷 트래픽 대역폭 제한**: 인터넷 트래픽 대역폭은 EC2 인스턴스 유형에 따라 달라집니다.
- **보안 그룹 및 규칙 관리 필요**: 인바운드 및 아웃바운드 트래픽을 적절히 관리해야 합니다.



**NAT 인스턴스 보안 그룹 설정**

- 인바운드 규칙
    - HTTP/HTTPS 트래픽 허용: 프라이빗 서브넷에서 오는 HTTP/HTTPS 트래픽을 허용합니다.
    - SSH 트래픽 허용: 관리 목적으로 홈 네트워크에서 오는 SSH 트래픽을 허용합니다.
- 아웃바운드 규칙
    - HTTP/HTTPS 트래픽 허용: 인터넷으로 나가는 HTTP/HTTPS 트래픽을 허용합니다.



## 9 Network Access Control List (NACL)

- **네트워크 ACL**은 서브넷에서 들어오고 나가는 트래픽을 제어하는 방화벽과 같은 역할을 합니다.
- 각 서브넷에는 하나의 NACL만 할당될 수 있으며, 새로운 서브넷은 기본 NACL에 할당됩니다.
- NACL은 무상태(stateless)입니다. 
	- 이는 들어오는 트래픽과 나가는 트래픽에 대해 별도의 규칙이 필요함을 의미합니다. 
	- 예를 들어, 들어오는 트래픽을 허용하는 규칙이 있다면, 나가는 트래픽을 별도로 허용해야 합니다.



### 9.1 NACL 규칙 정의

- NACL 규칙은 숫자(1-32766)로 정의되며, 숫자가 낮을수록 높은 우선순위를 갖습니다.
- 첫 번째로 일치하는 규칙이 트래픽 제어 결정을 내립니다.
- 예시: `#100 ALLOW 10.0.0.10/32`와 `#200 DENY 10.0.0.10/32`를 정의한 경우, 100번 규칙이 200번 규칙보다 우선하여 해당 IP 주소를 허용합니다.
- 마지막 규칙은 별표`*`로 표시되며, 일치하는 규칙이 없을 경우 요청을 거부합니다.
- AWS는 규칙을 100단위로 추가할 것을 권장합니다.
- 새로 생성된 NACL은 모든 트래픽을 기본적으로 거부합니다.



### 9.2 기본 NACL (Default NACL)

- 기본 NACL은 모든 인바운드 및 아웃바운드 트래픽을 허용합니다.
- 기본 NACL을 수정하지 말고, 대신 커스텀 NACL을 생성하는 것을 권장합니다.
- 기본 NACL은 모든 인바운드 및 아웃바운드 트래픽을 허용하지만, 사용자 정의 NACL을 생성하여 특정 트래픽을 제어할 수 있습니다.


**기본 인바운드 규칙**

|Rule #|Type|Protocol|Port Range|Source|Allow/Deny|
|---|---|---|---|---|---|
|100|All IPv4 Traffic|All|All|0.0.0.0/0|ALLOW|
|*|All IPv4 Traffic|All|All|0.0.0.0/0|DENY|



**기본 아웃바운드 규칙**

|Rule #|Type|Protocol|Port Range|Destination|Allow/Deny|
|---|---|---|---|---|---|
|100|All IPv4 Traffic|All|All|0.0.0.0/0|ALLOW|
|*|All IPv4 Traffic|All|All|0.0.0.0/0|DENY|



### 9.3 임시 포트 (Ephemeral Ports)

- 임시 포트는 두 엔드포인트가 연결을 설정할 때 사용되는 포트입니다.
- 클라이언트는 정의된 포트에 연결하며, 응답을 임시 포트에서 받기를 기대합니다.
- 운영 체제마다 사용하는 임시 포트 범위가 다릅니다.
    - 예: IANA 및 MS Windows 10은 49152–65535 범위를 사용합니다.
    - 많은 Linux 커널은 32768 – 60999 범위를 사용합니다.



**예시: 웹 티어와 데이터베이스 티어 간의 통신**

![[Pasted image 20240705110600.png]]

- **웹 티어(Web Tier)**: 퍼블릭 서브넷에 위치하며 클라이언트 요청을 처리합니다.
- **데이터베이스 티어(Database Tier)**: 프라이빗 서브넷에 위치하며 데이터베이스 요청을 처리합니다.
- 웹 티어에서 데이터베이스 티어로의 아웃바운드 트래픽:
    - 아웃바운드 TCP: 포트 3306 (MySQL)로 DB 서브넷 CIDR로 허용
- 데이터베이스 티어에서 웹 티어로의 인바운드 트래픽:
    - 인바운드 TCP: 포트 3306 (MySQL)로 웹 서브넷 CIDR에서 허용
- 웹 티어로부터의 인바운드 트래픽:
    - 인바운드 TCP: 포트 1024-65535로 DB 서브넷 CIDR에서 허용
- 데이터베이스 티어로부터의 아웃바운드 트래픽:
    - 아웃바운드 TCP: 포트 1024-65535로 웹 서브넷 CIDR로 허용



## 10 Security Group

- **보안 그룹**은 인스턴스 수준에서 트래픽을 제어하는 가상 방화벽입니다.
- 허용된 인바운드 및 아웃바운드 트래픽을 정의합니다.
- 상태 저장(stateful)입니다. 
	- 이는 인바운드 규칙이 허용된 경우, 해당 트래픽에 대한 아웃바운드 응답이 자동으로 허용됨을 의미합니다.
	- 반대로 아웃바운드 규칙이 허용된 경우, 해당 트래픽에 대한 인바운드 응답도 자동으로 허용됩니다.



### 10.1 보안 그룹 설정

- **인바운드 규칙**: 인스턴스에 들어오는 트래픽을 제어합니다.
    - 예: 특정 IP 주소에서의 SSH(포트 22) 접근 허용
- **아웃바운드 규칙**: 인스턴스에서 나가는 트래픽을 제어합니다.
    - 예: 모든 트래픽이 인터넷으로 나가는 것을 허용



## 11 NACL과 보안 그룹의 상호작용

- 네트워크 ACL(NACL)과 보안 그룹(SG)은 VPC 보안의 두 가지 중요한 계층입니다. 
- 두 구성 요소가 함께 작동하여 트래픽을 필터링합니다.



### 11.1 인바운드 트래픽

- **NACL**
    - 서브넷 수준에서 첫 번째 방어선 역할을 합니다. 
    - 인바운드 트래픽이 서브넷에 도달하기 전에 NACL 규칙에 따라 필터링됩니다.
    - 예: NACL 규칙에서 특정 IP의 SSH(포트 22) 접근을 허용하지 않으면 해당 트래픽은 서브넷에 도달하지 않습니다.
- **보안 그룹(SG)**\
    - 인스턴스 수준에서 추가 필터링을 수행합니다. 
    - NACL을 통과한 트래픽이 보안 그룹의 인바운드 규칙에 따라 다시 필터링됩니다.
    - 예: 보안 그룹에서 특정 IP의 SSH(포트 22) 접근을 허용하지 않으면 해당 트래픽은 인스턴스에 도달하지 않습니다.



### 11.2 아웃바운드 트래픽

- **보안 그룹(SG)**
    - 인스턴스에서 나가는 트래픽을 먼저 필터링합니다. 
    - 보안 그룹의 아웃바운드 규칙에 따라 트래픽이 필터링됩니다.
    - 예: 보안 그룹에서 모든 아웃바운드 HTTP(포트 80) 트래픽을 허용하면 해당 트래픽은 인스턴스를 나갈 수 있습니다.
- **NACL**
    - 서브넷을 나가는 트래픽을 추가로 필터링합니다. 
    - 보안 그룹을 통과한 트래픽이 NACL의 아웃바운드 규칙에 따라 다시 필터링됩니다.
    - 예: NACL에서 특정 IP로의 HTTP(포트 80) 접근을 허용하지 않으면 해당 트래픽은 서브넷을 나갈 수 없습니다.



### 11.3 NACL과 보안 그룹의 주요 차이점 요약

- **보안 그룹(SG)**:
    - **상태 저장(stateful)**: 인바운드 트래픽이 허용되면 아웃바운드 응답도 자동으로 허용됩니다.
    - **인스턴스 수준에서 작동**: 각 EC2 인스턴스에 직접 적용됩니다.
    - **허용 규칙만 지원**: 트래픽을 허용할 규칙만 정의할 수 있습니다.
    - **모든 규칙을 평가 후 결정**: 트래픽을 허용할지 여부를 결정하기 전에 모든 규칙을 평가합니다.
    - **특정 EC2 인스턴스에 적용**: 사용자가 지정한 EC2 인스턴스에 적용됩니다.
    - **기본 설정**: 기본적으로 모든 인바운드 트래픽을 거부하고, 모든 아웃바운드 트래픽을 허용합니다.
- **네트워크 ACL(NACL)**:
    - **무상태(stateless)**: 인바운드 및 아웃바운드 트래픽에 대해 별도의 규칙이 필요합니다.
        - 이는 반환 트래픽도 규칙에 의해 명시적으로 허용되어야 함을 의미합니다.
    - **서브넷 수준에서 작동**: 각 서브넷에 자동으로 적용됩니다.
    - **허용 및 거부 규칙 지원**: 트래픽을 허용하거나 거부할 규칙을 정의할 수 있습니다.
    - **규칙 번호에 따라 평가**: 규칙은 낮은 숫자부터 높은 숫자 순으로 평가되며, 첫 번째로 일치하는 규칙이 트래픽 제어를 결정합니다.
    - **자동 적용**: 서브넷에 연결된 모든 EC2 인스턴스에 자동으로 적용됩니다.
    - **기본 설정**: 기본적으로 모든 인바운드 및 아웃바운드 트래픽을 거부합니다.



#### 보안 그룹과 NACL 비교 요약

|특성|보안 그룹(SG)|네트워크 ACL(NACL)|
|---|---|---|
|작동 수준|인스턴스 수준|서브넷 수준|
|지원 규칙|허용 규칙만 지원|허용 및 거부 규칙 지원|
|상태 저장 여부|상태 저장(stateful)|무상태(stateless)|
|규칙 평가 방식|모든 규칙을 평가 후 결정|규칙 번호 순으로 평가, 첫 번째 일치 규칙 적용|
|적용 방법|지정된 EC2 인스턴스에만 적용|서브넷에 연결된 모든 인스턴스에 자동 적용|



**참고 자료**

- [Amazon VPC 공식 문서](https://docs.aws.amazon.com/vpc/index.html)
- [AWS Management Console](https://aws.amazon.com/console/)