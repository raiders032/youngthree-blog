## 1 VPC Endpoints (AWS PrivateLink)

- VPC Endpoints는 AWS PrivateLink를 통해 AWS 서비스에 접근할 때 퍼블릭 인터넷 대신 프라이빗 네트워크를 사용할 수 있게 해줍니다.
- 이를 통해 보안성과 성능을 향상시킬 수 있습니다.
	- **보안성**: 퍼블릭 인터넷을 거치지 않고 VPC 내부에서 직접 AWS 서비스에 접근할 수 있기 때문에, 외부 공격에 노출될 가능성이 줄어듭니다. 또한, 트래픽이 인터넷으로 나가지 않으므로 데이터 보안이 강화됩니다.
	- **성능 향상**: 트래픽이 VPC 내부에서만 이동하므로, 네트워크 지연(latency) 시간이 줄어들고, 안정적인 성능을 유지할 수 있습니다. 또한, 인터넷 게이트웨이 또는 NAT 게이트웨이 등을 통해 데이터를 전송할 필요가 없으므로 데이터 전송 속도가 향상됩니다.



## 2 주요 특징

### 2.1 퍼블릭 URL과 프라이빗 네트워크

- 모든 AWS 서비스는 기본적으로 퍼블릭 URL을 통해 공개됩니다.
- VPC Endpoints를 사용하면 이러한 서비스에 프라이빗 네트워크를 통해 접근할 수 있습니다.



### 2.2 AWS PrivateLink

- VPC Endpoints는 AWS PrivateLink를 기반으로 작동합니다.
- 이를 통해 AWS 서비스와 안전하게 연결할 수 있습니다.



### 2.3 중복성과 확장성

- VPC Endpoints는 여러 인스턴스가 동시에 작동하여 높은 가용성을 유지합니다.
- 필요에 따라 수평적으로 확장할 수 있어, 트래픽 증가에도 안정적으로 서비스를 제공합니다.



### 2.4 인터넷 게이트웨이, NAT 게이트웨이 불필요

- VPC Endpoints를 사용하면 AWS 서비스에 접근하기 위해 인터넷 게이트웨이(IGW)나 NAT 게이트웨이(NATGW)가 필요하지 않습니다.
- 이를 통해 네트워크 설정을 간소화하고 비용을 절감할 수 있습니다.



## 3 VPC Endpoints의 종류

### 3.1 인터페이스 엔드포인트

- 인터페이스 엔드포인트는 PrivateLink를 기반으로 동작합니다.
- 네트워크 인터페이스(ENI)를 프로비저닝하며, 이를 진입점으로 사용합니다.
- 보안 그룹을 반드시 연결해야 합니다.
- 대부분의 AWS 서비스를 지원합니다.
- 시간당 비용과 처리된 데이터 양에 따라 비용이 청구됩니다.



**S3와 통합**

- Amazon S3에 인터페이스 엔드포인트를 직접 적용할 수는 없습니다. 
- 대신, S3와의 통신을 위해서는 **Gateway Endpoint**를 사용합니다.



### 3.2 게이트웨이 엔드포인트

- 게이트웨이 엔드포인트는 게이트웨이를 프로비저닝하며, 라우팅 테이블의 대상으로 사용됩니다.
- 보안 그룹을 사용하지 않습니다.
- S3와 DynamoDB를 지원합니다.
	- 게이트웨이 엔드포인트는 Amazon S3와 DynamoDB에만 사용 가능합니다. 
	- 다른 AWS 서비스에 접근하려면 인터페이스 엔드포인트를 사용해야 합니다. 
	- 인터페이스 엔드포인트는 AWS PrivateLink를 기반으로 하며, 보안 그룹을 사용하여 접근 제어를 설정할 수 있습니다.
- 무료로 제공됩니다.



### 3.3 S3를 위한 엔드포인트 선택

- S3에 대한 엔드포인트를 선택할 때, 주로 게이트웨이 엔드포인트를 선호합니다.
- 게이트웨이 엔드포인트는 무료로 제공되며, 비용 절감에 유리합니다.
- 인터페이스 엔드포인트는 시간당 비용과 처리된 데이터 양에 따라 비용이 청구됩니다.
- 언제 인터페이스 엔드포인트를 선택해야 할까?
	- 온프레미스에서 접근이 필요한 경우 (Site-to-Site VPN 또는 Direct Connect)
	- 다른 VPC 또는 다른 리전에서 접근이 필요한 경우
	- 이러한 경우에는 인터페이스 엔드포인트가 더 적합합니다.



### 3.4 VPC 엔드포인트를 통한 S3 버킷 접근 제어

- 한 회사가 동일한 VPC 내에 여러 개의 VPC 엔드포인트를 가지고 있고, 이 엔드포인트들을 통해서만 S3 버킷에 접근할 수 있도록 설정해야 하는 경우가 있습니다. 
- 이를 위해 S3 버킷 정책을 특별히 구성해야 합니다. 
- 아래는 이를 위한 접근 방법입니다:
	1. **단일 정책 사용:** 모든 VPC 엔드포인트에 대한 접근을 관리하기 위해 하나의 S3 버킷 정책을 생성합니다.
	2. **VPC 엔드포인트 ID 지정:** 정책 내에 접근을 허용할 모든 VPC 엔드포인트 ID를 나열합니다.
	3. **올바른 조건 키 사용:** VPC 엔드포인트를 지정하기 위해 `aws:SourceVpce` 조건 키를 사용합니다.
	4. **StringNotEquals 조건 적용:** 지정된 VPC 엔드포인트를 통한 접근만을 허용하기 위해 `StringNotEquals` 조건을 사용합니다.



**예시**

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AccessViaSpecificVPCEndpoints",
            "Effect": "Deny",
            "Principal": "*",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::your-bucket-name",
                "arn:aws:s3:::your-bucket-name/*"
            ],
            "Condition": {
                "StringNotEquals": {
                    "aws:SourceVpce": ["vpce-11111111", "vpce-22222222", "vpce-33333333"]
                }
            }
        }
    ]
}
```

- 이 정책은 지정된 VPC 엔드포인트를 통해 오는 요청이 아니면 S3 버킷에 대한 접근을 거부합니다.



## 4 설정 절차

### 4.1 VPC Endpoint 생성

- AWS Management Console, AWS CLI, 또는 SDK를 사용하여 VPC Endpoint를 생성합니다.
- VPC Endpoint를 생성할 때 연결할 AWS 서비스와 VPC를 선택합니다.



### 4.2 라우팅 테이블 업데이트

- VPC Endpoint를 설정한 후 해당 VPC의 라우팅 테이블을 업데이트해야 합니다.
- 이를 통해 트래픽이 VPC Endpoint를 통해 AWS 서비스로 라우팅됩니다.



### 4.3 DNS 설정 확인

- VPC의 DNS 설정을 확인하고 필요시 수정해야 합니다.
- 올바른 DNS 설정을 통해 AWS 서비스에 대한 프라이빗 접근을 보장할 수 있습니다.



## 5 문제 해결

### 5.1 DNS 설정 확인

- VPC Endpoints와 관련된 문제 발생 시, 먼저 VPC의 DNS 설정을 확인합니다.
- DNS 해상도가 올바르게 설정되어 있는지 점검합니다.



### 5.2 라우팅 테이블 확인

- 또한, 라우팅 테이블을 확인하여 VPC Endpoint로의 경로가 올바르게 설정되어 있는지 확인합니다.
- 라우팅 테이블에 오류가 있을 경우 트래픽이 제대로 라우팅되지 않을 수 있습니다.



## 6 Lambda in VPC accessing DynamoDB 예시

![[Pasted image 20240707171005.png]]

### 6.1 DynamoDB는 퍼블릭 서비스

- DynamoDB는 AWS에서 제공하는 퍼블릭 서비스입니다.
- Lambda가 VPC 내부에서 DynamoDB에 접근하는 방법에는 두 가지 옵션이 있습니다.



### 6.2 옵션 1: 퍼블릭 인터넷을 통한 접근

- Lambda가 VPC 내부에 있을 경우, 퍼블릭 인터넷을 통해 DynamoDB에 접근하려면 NAT 게이트웨이와 인터넷 게이트웨이가 필요합니다.
- 퍼블릭 서브넷에 NAT 게이트웨이를 배치하고, 인터넷 게이트웨이를 통해 트래픽을 라우팅합니다.



### 6.3 옵션 2: 프라이빗 VPC 네트워크를 통한 접근 (더 나은 옵션)

- 더 나은 방법은 프라이빗 VPC 네트워크를 통해 DynamoDB에 접근하는 것입니다.
- VPC 게이트웨이 엔드포인트를 배포하여 DynamoDB에 접근합니다.
- 라우팅 테이블을 수정하여 트래픽이 VPC 게이트웨이 엔드포인트를 통해 DynamoDB로 라우팅되도록 설정합니다.
- 이 옵션은 무료이며, 네트워크 트래픽을 퍼블릭 인터넷을 거치지 않고 안전하게 관리할 수 있습니다.